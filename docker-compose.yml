services:
  a1111:
    build:
      context: .
      dockerfile: Dockerfile
    image: stable-diffusion-webui:latest
    container_name: a1111
    ports:
      - "7860:7860"
    volumes:
      - ./configs:/workspace/stable-diffusion-webui/configs
      - ./models:/workspace/stable-diffusion-webui/models
      - ./outputs:/workspace/stable-diffusion-webui/outputs
      - ./extensions:/workspace/stable-diffusion-webui/extensions
      - ./extensions/wildcards:/workspace/stable-diffusion-webui/extensions/wildcards
      - ./embeddings:/workspace/stable-diffusion-webui/embeddings
      - ./logs:/workspace/stable-diffusion-webui/logs
      - ./cache:/workspace/stable-diffusion-webui/cache
      - ./cache/huggingface:/workspace/stable-diffusion-webui/cache/huggingface
      - ./repositories:/workspace/stable-diffusion-webui/repositories
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    environment:
      - CLI_ARGS=--xformers --enable-insecure-extension-access
      - LD_PRELOAD=/usr/lib/x86_64-linux-gnu/libtcmalloc.so
    restart: unless-stopped
